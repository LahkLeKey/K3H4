services:
  api:
    build:
      context: ./apps/api.k3h4.io
      dockerfile: Dockerfile
      args:
        DATABASE_URL: ${DATABASE_URL}
        JWT_SECRET: ${JWT_SECRET:-change-me}
    command: ["bun", "run", "src/server.ts"]
    env_file:
      - ./apps/api.k3h4.io/.env
    environment:
      - CORS_ORIGIN=http://localhost:5173
      - PORT=8080
      - HOST=0.0.0.0
      - OLLAMA_URL=http://ollama:11434
    ports:
      - "3001:8080"
    healthcheck:
      test: ["CMD", "bun", "-e", "await fetch('http://localhost:8080/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 12
      start_period: 5s
    depends_on:
      - ollama

  ollama:
    build:
      context: ./sidecars/ollama
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_HTTP_PORT=11434
    ports:
      - "11434:11434"
    volumes:
      - ./sidecars/ollama/data:/ollama/data
      - ./sidecars/ollama/preload-models.txt:/etc/ollama/preload-models.txt:ro

  web:
    image: oven/bun:1.3.5
    working_dir: /app
    volumes:
      - ./apps/www.k3h4.io:/app
    environment:
      # Enable polling so file changes from host (Windows/macOS bind mounts) trigger Vite/Bun watchers without restarting the container
      - CHOKIDAR_USEPOLLING=1
      - BUN_WATCHER_USE_POLLING=1
      - BUN_WATCHER_POLL_INTERVAL=500
    command: ["sh", "-c", "bun install && bun run dev --host --port 5173"]
    env_file:
      - ./apps/www.k3h4.io/.env
    ports:
      - "5173:5173"

