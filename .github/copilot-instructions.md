## K3H4 AI Guide

- Monorepo with two apps: Fastify+Prisma API at [apps/api.k3h4.io](apps/api.k3h4.io) and Bun+Vite React SPA at [apps/www.k3h4.io](apps/www.k3h4.io). Repo scripts assume Bun 1.3.x.
- Quick run: `bun install`; API `cd apps/api.k3h4.io && bun run dev`; web `cd apps/www.k3h4.io && bun run dev`. Docker helper: root `bun run dev` (docker compose up), `bun run compose:down`.
- Testing: API `bun run test` (or `test:coverage`), web `bun run test` (or `--coverage`). Root `bun run coverage:report` updates README coverage snapshot.
- API service ([apps/api.k3h4.io/src/server.ts](apps/api.k3h4.io/src/server.ts)) uses Fastify with `@fastify/jwt`, Swagger UI at `/docs`, CORS from `CORS_ORIGIN`, and telemetry ingestion at `/telemetry`. JWT secret defaults to dev value; set `JWT_SECRET` in real runs.
- Prisma client is created with `PrismaPg` adapter; `DATABASE_URL` is required. Migrations via `bun run prisma:migrate`; schema at [apps/api.k3h4.io/prisma/schema.prisma](apps/api.k3h4.io/prisma/schema.prisma).
- Routes are registered per domain (auth, profile, bank, persona, assignment, freight, warehouse, pos, agriculture, culinary, arcade) via `register*Routes` helpers; add new endpoints by following the pattern in [apps/api.k3h4.io/src/routes/bank.ts](apps/api.k3h4.io/src/routes/bank.ts) and wiring them in `server.ts`.
- Protected endpoints use `preHandler: [server.authenticate]`; `request.jwtVerify()` sets `request.user.sub`. Prefer using `recordTelemetry` (from `server.ts`) for meaningful events/errors; it stores to `telemetryEvent` without blocking requests.
- Auth is OAuth-only: `/auth/github/url` and `/auth/github/callback` exchange codes, persist users, and issue access/refresh tokens; see [apps/api.k3h4.io/src/routes/auth.ts](apps/api.k3h4.io/src/routes/auth.ts). LinkedIn flow mirrors GitHub. `/auth/me` returns the current user.
- Bank domain illustrates transactional writes: normalize amounts, run Prisma `$transaction`, and emit telemetry on success/failure. Keep the `MAX_ABSOLUTE_BALANCE` guard when extending.
- Web app bootstraps in [apps/www.k3h4.io/src/main.tsx](apps/www.k3h4.io/src/main.tsx): HashRouter, `QueryClientProvider`, and `ErrorBoundary`. It rewrites `/auth/github` pathname to a hash route so OAuth callbacks land inside the SPA.
- Client build pipeline is custom Bun script [apps/www.k3h4.io/scripts/build.ts](apps/www.k3h4.io/scripts/build.ts): cleans `dist`, copies `public`, builds Tailwind CSS, and injects `API_URL`/`GITHUB_CLIENT_ID` into `index.html` and `import.meta.env`. Use these env vars (or globals `__API_URL__`, `__GITHUB_CLIENT_ID`) instead of hardcoding URLs.
- Default query settings live in [apps/www.k3h4.io/src/lib/query-client.ts](apps/www.k3h4.io/src/lib/query-client.ts) (30s stale, no refetch-on-focus, retry=1). Prefer TanStack Query hooks under [apps/www.k3h4.io/src/hooks](apps/www.k3h4.io/src/hooks) instead of manual fetch.
- Auth flows on the web: `useAuthProfile` orchestrates session fetch, profile fetch/save, GitHub redirect, token storage, and sign-out, pulling state from the Zustand store [apps/www.k3h4.io/src/stores/auth-store.ts](apps/www.k3h4.io/src/stores/auth-store.ts). Tokens live in localStorage keys from [apps/www.k3h4.io/src/lib/constants.ts](apps/www.k3h4.io/src/lib/constants.ts); auth errors clear caches and dispatch `k3h4:auth-signed-out`.
- Bank UI uses query hooks [apps/www.k3h4.io/src/hooks/use-bank-queries.ts](apps/www.k3h4.io/src/hooks/use-bank-queries.ts) and orchestration hook [apps/www.k3h4.io/src/hooks/use-k3h4-bank.ts](apps/www.k3h4.io/src/hooks/use-k3h4-bank.ts); state is in [apps/www.k3h4.io/src/stores/bank-store.ts](apps/www.k3h4.io/src/stores/bank-store.ts). Follow this pattern for other domains.
- State pattern: custom `createStore` wrapper over Zustand in [apps/www.k3h4.io/src/lib/store.ts](apps/www.k3h4.io/src/lib/store.ts) adds `useShallow`; use `useLocalStore` for component-scoped stores to avoid cross-talk.
- Telemetry: DOM event hooks and manual events enqueue to `/telemetry` with session id and optional auth token; see [apps/www.k3h4.io/src/lib/telemetry.ts](apps/www.k3h4.io/src/lib/telemetry.ts). When adding UI, emit `trackTelemetry` events for key flows instead of console logs.
- Navigation/layout: SPA shell is in [apps/www.k3h4.io/src/components/shell.tsx](apps/www.k3h4.io/src/components/shell.tsx) and domain panels live under [apps/www.k3h4.io/src/components](apps/www.k3h4.io/src/components). Routes/sections align with backend domains (bank, freight, warehouse, agriculture, culinary, POS, personas, arcade).
- Graphics/arcade experiences (R3F/three.js) live under [apps/www.k3h4.io/src/components/arcade](apps/www.k3h4.io/src/components/arcade); keep them isolated from business flows and reuse the shared canvas utilities.
- When adding API calls: use the existing query/mutation hooks; include Authorization header from stored token; mirror backend telemetry event names for parity. Avoid duplicating API base detection; rely on `apiBase` from stores or env globals.
