generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "./prisma/generated/schemas"
}

datasource db {
  provider = "postgresql"
}

enum BuildingType {
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
}

enum ChatRole {
  SYSTEM
  USER
  ASSISTANT
}

enum LifecycleStatus {
  ACTIVE    @map("active")
  INACTIVE  @map("inactive")
  OPEN      @map("open")
  CLOSED    @map("closed")
  PENDING   @map("pending")
  PLANNING  @map("planning")
  COMPLETED @map("completed")
  STORED    @map("stored")
  IDLE      @map("idle")
  SCHEDULED @map("scheduled")
  UNFILLED  @map("unfilled")
}

enum EngagementPriority {
  LOW    @map("low")
  NORMAL @map("normal")
  MEDIUM @map("medium")
  HIGH   @map("high")
  URGENT @map("urgent")
}

enum CoverageStatus {
  UNFILLED @map("unfilled")
  FILLED   @map("filled")
  PARTIAL  @map("partial")
}

enum WarehouseCategory {
  AGRICULTURE @map("agriculture")
  OTHER       @map("other")
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  provider        String
  providerId      String
  k3h4CoinBalance Decimal  @default("25000") @db.Decimal(18, 2) // sandbox-only play balance
  displayName     String?
  avatarUrl       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  actors          Actor[]

  @@unique([provider, providerId])
}

model Actor {
  id         String    @id @default(cuid())
  userId     String?
  user       User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  label      String
  type       String
  note       String?
  source     String?
  metadata   Json?
  osmType    String?
  osmId      BigInt?   @db.BigInt
  latitude   Decimal?  @db.Decimal(11, 6)
  longitude  Decimal?  @db.Decimal(11, 6)
  category   String?
  lastSeenAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  entities Entity[]
  caches   ActorCache[]

  @@unique([type, osmType, osmId], name: "actor_poi_osm_unique")
  @@index([userId])
  @@index([type])
  @@index([category])
  @@index([latitude, longitude])
}

model Entity {
  id         String   @id @default(cuid())
  actorId    String
  actor      Actor    @relation(fields: [actorId], references: [id], onDelete: Cascade)
  kind       String
  direction  String?
  name       String?
  targetType String?
  targetId   String?
  source     String?
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  caches EntityCache[]

  @@index([actorId])
  @@index([kind])
  @@index([targetType, targetId])
  @@index([direction])
}

model ActorCache {
  id        String    @id @default(cuid())
  actorId   String
  actor     Actor     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  key       String
  payload   Json?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([actorId, key], name: "actor_cache_key")
  @@index([expiresAt])
}

model EntityCache {
  id        String    @id @default(cuid())
  entityId  String
  entity    Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)
  key       String
  payload   Json?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([entityId, key], name: "entity_cache_key")
  @@index([expiresAt])
}
