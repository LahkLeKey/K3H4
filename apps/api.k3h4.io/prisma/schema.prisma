generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "./prisma/generated/schemas"
}

datasource db {
  provider = "postgresql"
}

enum BuildingType {
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
}

enum ChatRole {
  SYSTEM
  USER
  ASSISTANT
}

enum LifecycleStatus {
  ACTIVE    @map("active")
  INACTIVE  @map("inactive")
  OPEN      @map("open")
  CLOSED    @map("closed")
  PENDING   @map("pending")
  PLANNING  @map("planning")
  COMPLETED @map("completed")
  STORED    @map("stored")
  IDLE      @map("idle")
  SCHEDULED @map("scheduled")
  UNFILLED  @map("unfilled")
}

enum ActorType {
  BANK_ACCOUNT                 @map("bank-account")
  ARCADE_MACHINE               @map("arcade-machine")
  ARCADE_PLAYER_CARD           @map("arcade-player-card")
  ARCADE_PRIZE                 @map("arcade-prize")
  USDA_FEED                    @map("usda-feed")
  AGRICULTURE_FARM             @map("agriculture-farm")
  AGRICULTURE_RESOURCE_LIBRARY @map("agriculture-resource-library")
  WAREHOUSE                    @map("warehouse")
  PERSONA                      @map("persona")
  STAFFING                     @map("staffing")
  ASSIGNMENT                   @map("assignment")
  AUTH                         @map("auth")
  TELEMETRY                    @map("telemetry")
  CULINARY                     @map("culinary")
  POINT_OF_SALE_STORE          @map("point-of-sale-store")
  GEO                          @map("geo")
  FREIGHT                      @map("freight")
  WIKIDATA_CACHE               @map("wikidata-cache")
  ENRICHMENT_CACHE             @map("enrichment-cache")
  API_CACHE                    @map("api-cache")
  AI_INSIGHT                   @map("ai-insight")
  AI_OPERATION                 @map("ai-operation")
  CHAT_SESSION                 @map("chat-session")
  POINT_OF_INTEREST            @map("point-of-interest")
  AUTH_REFRESH_TOKEN           @map("auth_refresh_token")
  AUTH_PROVIDER_GRANT          @map("auth_provider_grant")
}

enum EntityDirection {
  CREDIT @map("credit")
  DEBIT  @map("debit")
}

enum EntityKind {
  DEPOSIT                        @map("deposit")
  WITHDRAWAL                     @map("withdrawal")
  SET                            @map("set")
  ASSIGNMENT_PAYOUT              @map("assignment_payout")
  FREIGHT_PAYMENT                @map("freight_payment")
  FREIGHT_LOAD                   @map("freight_load")
  AI_INSIGHT                     @map("ai_insight")
  CHAT_MESSAGE                   @map("chat-message")
  OLLAMA_OPERATION               @map("ollama_operation")
  ARCADE_TOPUP                   @map("arcade_topup")
  ARCADE_SESSION                 @map("arcade_session")
  ARCADE_PRIZE_REDEMPTION        @map("arcade_prize_redemption")
  USDA_REGION                    @map("usda-region")
  USDA_COUNTRY                   @map("usda-country")
  USDA_COMMODITY                 @map("usda-commodity")
  USDA_UNIT                      @map("usda-unit")
  USDA_ATTRIBUTE                 @map("usda-attribute")
  AGRICULTURE_PLOT               @map("agriculture_plot")
  AGRICULTURE_PLOT_CONDITION     @map("agriculture_plot_condition")
  AGRICULTURE_SLOT               @map("agriculture_slot")
  AGRICULTURE_CROP_PLAN          @map("agriculture_crop_plan")
  AGRICULTURE_TASK               @map("agriculture_task")
  AGRICULTURE_INVENTORY_ITEM     @map("agriculture_inventory_item")
  AGRICULTURE_INVENTORY_MOVEMENT @map("agriculture_inventory_movement")
  AGRICULTURE_SHIPMENT           @map("agriculture_shipment")
  AGRICULTURE_RESOURCE_CATEGORY  @map("agriculture_resource_category")
  AGRICULTURE_RESOURCE           @map("agriculture_resource")
  WAREHOUSE_ITEM                 @map("warehouse_item")
  PERSONA                        @map("persona")
  PERSONA_ATTRIBUTE              @map("persona_attribute")
  PERSONA_COMPATIBILITY          @map("persona_compatibility")
  STAFFING_ENGAGEMENT            @map("staffing_engagement")
  STAFFING_ROLE                  @map("staffing_role")
  STAFFING_CANDIDATE             @map("staffing_candidate")
  STAFFING_SHIFT                 @map("staffing_shift")
  STAFFING_PLACEMENT             @map("staffing_placement")
  ASSIGNMENT                     @map("assignment")
  ASSIGNMENT_TIMECARD            @map("assignment_timecard")
  CULINARY_MENU_ITEM             @map("culinary-menu-item")
  CULINARY_PREP_TASK             @map("culinary-prep-task")
  CULINARY_SUPPLIER_NEED         @map("culinary-supplier-need")
  POINT_OF_SALE_TICKET           @map("point-of-sale_ticket")
  AUTH_REFRESH_TOKEN             @map("auth_refresh_token")
  AUTH_PROVIDER_GRANT            @map("auth_provider_grant")
  TELEMETRY_EVENT                @map("telemetry-event")
}

enum EngagementPriority {
  LOW    @map("low")
  NORMAL @map("normal")
  MEDIUM @map("medium")
  HIGH   @map("high")
  URGENT @map("urgent")
}

enum CoverageStatus {
  UNFILLED @map("unfilled")
  FILLED   @map("filled")
  PARTIAL  @map("partial")
}

enum WarehouseCategory {
  AGRICULTURE @map("agriculture")
  OTHER       @map("other")
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  provider        String
  providerId      String
  k3h4CoinBalance Decimal  @default("25000") @db.Decimal(18, 2) // sandbox-only play balance
  displayName     String?
  avatarUrl       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  actors          Actor[]

  @@unique([provider, providerId])
}

model Actor {
  id         String    @id @default(cuid())
  userId     String?
  user       User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  label      String
  type       ActorType
  note       String?
  source     String?
  metadata   Json?
  osmType    String?
  osmId      BigInt?   @db.BigInt
  latitude   Decimal?  @db.Decimal(11, 6)
  longitude  Decimal?  @db.Decimal(11, 6)
  category   String?
  lastSeenAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  entities Entity[]
  caches   ActorCache[]

  @@unique([type, osmType, osmId], name: "actor_poi_osm_unique")
  @@index([userId])
  @@index([type])
  @@index([category])
  @@index([latitude, longitude])
}

model Entity {
  id         String           @id @default(cuid())
  actorId    String
  actor      Actor            @relation(fields: [actorId], references: [id], onDelete: Cascade)
  kind       EntityKind
  direction  EntityDirection?
  name       String?
  targetType String?
  targetId   String?
  source     String?
  metadata   Json?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  caches EntityCache[]

  @@index([actorId])
  @@index([kind])
  @@index([targetType, targetId])
  @@index([direction])
}

model ActorCache {
  id        String    @id @default(cuid())
  actorId   String
  actor     Actor     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  key       String
  payload   Json?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([actorId, key], name: "actor_cache_key")
  @@index([expiresAt])
}

model EntityCache {
  id        String    @id @default(cuid())
  entityId  String
  entity    Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)
  key       String
  payload   Json?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([entityId, key], name: "entity_cache_key")
  @@index([expiresAt])
}
