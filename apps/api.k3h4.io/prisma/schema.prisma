generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "./prisma/generated/schemas"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  provider        String
  providerId      String
  k3h4CoinBalance Decimal  @default("25000") @db.Decimal(18, 2) // sandbox-only play balance
  displayName     String?
  avatarUrl       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  actors          Actor[]

  @@unique([provider, providerId])
}

model Actor {
  id         String    @id @default(cuid())
  userId     String?
  user       User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  label      String
  type       String
  note       String?
  source     String?
  metadata   Json?
  category   String?
  lastSeenAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  entities Entity[]
  caches   ActorCache[]

  @@index([userId])
  @@index([type])
  @@index([category])
}

model Entity {
  id         String   @id @default(cuid())
  actorId    String
  actor      Actor    @relation(fields: [actorId], references: [id], onDelete: Cascade)
  kind       String
  direction  String?
  name       String?
  targetType String?
  targetId   String?
  source     String?
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  caches EntityCache[]

  @@index([actorId])
  @@index([kind])
  @@index([targetType, targetId])
  @@index([direction])
}

model ActorCache {
  id        String    @id @default(cuid())
  actorId   String
  actor     Actor     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  key       String
  payload   Json?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([actorId, key], name: "actor_cache_key")
  @@index([expiresAt])
}

model EntityCache {
  id        String    @id @default(cuid())
  entityId  String
  entity    Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)
  key       String
  payload   Json?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([entityId, key], name: "entity_cache_key")
  @@index([expiresAt])
}
